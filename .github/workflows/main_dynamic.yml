name: Deploy Django on Remote VM - Dynamic

on:
  workflow_dispatch:  # Allows manual trigger
  push:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Azure CLI & SSH Client
        run: |
          echo "ðŸš€ Installing Azure CLI..."
          sudo apt-get update -y
          sudo apt-get install -y azure-cli openssh-client sshpass jq

      - name: Login to Azure with SPN
        run: |
          echo "ðŸ”‘ Logging into Azure..."
          az login --service-principal \
            --username "${{ secrets.SPN_CLIENT_ID }}" \
            --password "${{ secrets.SPN_SECRET }}" \
            --tenant "${{ secrets.SPN_TENANT_ID }}"

      - name: Fetch VM Public IP from Azure
        id: get-vm-ip
        run: |
          echo "ðŸ” Fetching VM Public IP..."
          VM_IP=$(az vm show -d --resource-group meta-minds-rg --name meta-minds-vm --query publicIps -o tsv)
          echo "VM_IP=${VM_IP}" >> $GITHUB_ENV
          echo "âœ… Found VM IP: $VM_IP"

      - name: Fetch VM Credentials from Key Vault
        id: get-vm-creds
        run: |
          echo "ðŸ” Fetching VM credentials from Key Vault..."
          VM_USERNAME=$(az keyvault secret show --vault-name meta-minds-kv --name vm-username --query value -o tsv)
          VM_PASSWORD=$(az keyvault secret show --vault-name meta-minds-kv --name vm-password --query value -o tsv)

          echo "::add-mask::$VM_PASSWORD"  # Mask password in logs
          echo "VM_USERNAME=${VM_USERNAME}" >> $GITHUB_ENV
          echo "VM_PASSWORD=${VM_PASSWORD}" >> $GITHUB_ENV
          echo "âœ… Fetched VM credentials successfully!"

      - name: Connect to VM & Check for Reboot
        run: |
          echo "ðŸš€ Checking if VM was rebooted..."
          sshpass -p "$VM_PASSWORD" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no "$VM_USERNAME@$VM_IP" << 'EOF'
            if [ -f /tmp/reboot-required-action ]; then
                echo "ðŸ”„ System was rebooted. Removing flag and continuing deployment..."
                sudo rm -f /tmp/reboot-required-action
                exit 0
            fi
            echo "âœ… No reboot detected. Proceeding with system update..."
          EOF

      - name: Perform System Update & Reboot if Required
        id: update_system
        run: |
          echo "ðŸš€ Updating system..."
          sshpass -p "$VM_PASSWORD" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no "$VM_USERNAME@$VM_IP" << 'EOF'
            export DEBIAN_FRONTEND=noninteractive
            sudo apt update -y && sudo apt upgrade -y
            sudo apt dist-upgrade -y

            if [ -f /var/run/reboot-required ]; then
                echo "âš ï¸ Kernel update detected! Marking reboot-required flag..."
                sudo touch /tmp/reboot-required-action
                sudo reboot
                exit 0
            fi
          EOF
        continue-on-error: true  # Prevents GitHub from marking the job as failed on reboot

      - name: Auto-Retry If Reboot Occurs
        if: failure() && steps.update_system.outcome == 'failure'
        run: |
          echo "âš ï¸ First run failed due to reboot. GitHub Actions will auto-retry this job."
          exit 1  # Forces GitHub Actions to retry the workflow

      - name: Connect to VM & Install Django
        run: |
          echo "ðŸš€ Connecting to Remote VM for Django Installation..."
          sshpass -p "$VM_PASSWORD" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no "$VM_USERNAME@$VM_IP" << 'EOF'
            echo "ðŸš€ Installing required packages..."
            sudo apt install -y python3 python3-pip

            echo "ðŸš€ Installing Django..."
            sudo -H pip3 install --upgrade pip
            sudo -H pip3 install django
          EOF

      - name: Install & Configure PostgreSQL
        run: |
          DB_NAME="${{ secrets.DB_NAME }}"
          DB_USER="${{ secrets.DB_USER }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
  
          echo "ðŸš€ Installing PostgreSQL..."
          sshpass -p "$VM_PASSWORD" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no "$VM_USERNAME@$VM_IP" << EOF
            sudo apt update -y
            sudo apt install -y postgresql postgresql-contrib libpq-dev
  
            echo "ðŸš€ Starting PostgreSQL service..."
            sudo systemctl enable postgresql
            sudo systemctl start postgresql
  
            echo "ðŸš€ Configuring PostgreSQL User and Database..."
            sudo -u postgres bash -c "
            export HOME=/var/lib/postgresql
            cd ~postgres
            psql -tAc \"SELECT 1 FROM pg_database WHERE datname='$DB_NAME'\" | grep -q 1 || psql -c \"CREATE DATABASE $DB_NAME;\"
            psql -tAc \"SELECT 1 FROM pg_roles WHERE rolname='$DB_USER'\" | grep -q 1 || psql -c \"CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';\"
            psql -c \"ALTER ROLE $DB_USER SET client_encoding TO 'utf8';\"
            psql -c \"ALTER ROLE $DB_USER SET default_transaction_isolation TO 'read committed';\"
            psql -c \"ALTER ROLE $DB_USER SET timezone TO 'UTC';\"
            psql -c \"GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;\"
            "
  
            echo "ðŸš€ Configuring PostgreSQL to accept remote connections..."
            sudo sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/" /etc/postgresql/*/main/postgresql.conf
  
            echo "host all all 0.0.0.0/0 md5" | sudo tee -a /etc/postgresql/*/main/pg_hba.conf
  
            echo "ðŸš€ Restarting PostgreSQL to apply changes..."
            sudo systemctl restart postgresql
          EOF
      - name: Deploy Django Application
        run: |
              echo "ðŸš€ Connecting to VM and setting up project..."
              sshpass -p "$VM_PASSWORD" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no "$VM_USERNAME@$VM_IP" << 'EOF'
                set -e  # Exit on error
  
                echo "ðŸ“‚ Navigating to home directory..."
                cd ~ || exit
  
                export DB_NAME="${{ secrets.DB_NAME }}"
                export DB_USER="${{ secrets.DB_USER }}"
                export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
                export DB_HOST="$VM_IP"

                echo "DB Host is $DB_HOST"
                # âœ… Handling private repository authentication (if repo is private)
                if [ ! -d "django-app" ]; then
                    echo "ðŸš€ Cloning repository..."
                    git clone https://github.com/madhum-py/django-my-course.git django-app
                else
                    echo "ðŸ”„ Updating existing repository..."
                    cd django-app
                    git reset --hard  # Remove any uncommitted changes
                    git pull origin main
                fi
  
                cd django-app  # Navigate to project directory
  
                echo "ðŸš€ Installing dependencies..."
                sudo apt update -y
                sudo apt install -y python3-pip
                sudo pip3 install --upgrade pip
                sudo pip3 install requests django-extensions psycopg2-binary
  
                echo "ðŸš€ Updating Django settings..."
                SETTINGS_FILE="registration_project/settings.py"
  
                # âœ… If DATABASES is not found, add it completely
                if ! grep -q "DATABASES =" "$SETTINGS_FILE"; then
                    echo "âš ï¸ DATABASES setting not found! Adding PostgreSQL configuration..."
                    sudo bash -c "cat <<EOT >> $SETTINGS_FILE
  
                    # DATABASE CONFIGURATION
                    DATABASES = {
                        'default': {
                            'ENGINE': 'django.db.backends.postgresql',
                            'NAME': '$DB_NAME',
                            'USER': '$DB_USER',
                            'PASSWORD': '$DB_PASSWORD',
                            'HOST': '$DB_HOST',
                            'PORT': '5432',
                        }
                    }
                    EOT"
                else
                    echo "âœ… DATABASES found. Ensuring all required fields are updated..."
  
                    # âœ… Ensure each value is updated or added if missing
                    sudo sed -i "/'ENGINE':/c\        'ENGINE': 'django.db.backends.postgresql'," "$SETTINGS_FILE"
                    sudo sed -i "/'NAME':/c\        'NAME': '$DB_NAME'," "$SETTINGS_FILE"
                    sudo sed -i "/'USER':/c\        'USER': '$DB_USER'," "$SETTINGS_FILE"
                    sudo sed -i "/'PASSWORD':/c\        'PASSWORD': '$DB_PASSWORD'," "$SETTINGS_FILE"
                    sudo sed -i "/'HOST':/c\        'HOST': '$DB_HOST'," "$SETTINGS_FILE"
                    sudo sed -i "/'PORT':/c\        'PORT': '5432'," "$SETTINGS_FILE"
  
                    # âœ… If some values were missing, add them inside the DATABASES['default'] block
                    if ! grep -q "'ENGINE':" "$SETTINGS_FILE"; then sudo sed -i "/'default': {/a\        'ENGINE': 'django.db.backends.postgresql'," "$SETTINGS_FILE"; fi
                    if ! grep -q "'NAME':" "$SETTINGS_FILE"; then sudo sed -i "/'default': {/a\        'NAME': '$DB_NAME'," "$SETTINGS_FILE"; fi
                    if ! grep -q "'USER':" "$SETTINGS_FILE"; then sudo sed -i "/'default': {/a\        'USER': '$DB_USER'," "$SETTINGS_FILE"; fi
                    if ! grep -q "'PASSWORD':" "$SETTINGS_FILE"; then sudo sed -i "/'default': {/a\        'PASSWORD': '$DB_PASSWORD'," "$SETTINGS_FILE"; fi
                    if ! grep -q "'HOST':" "$SETTINGS_FILE"; then sudo sed -i "/'default': {/a\        'HOST': '$DB_HOST'," "$SETTINGS_FILE"; fi
                    if ! grep -q "'PORT':" "$SETTINGS_FILE"; then sudo sed -i "/'default': {/a\        'PORT': '5432'," "$SETTINGS_FILE"; fi
                fi
  
                echo "ðŸš€ Running database migrations..."
                sudo python3 manage.py migrate
  
                echo "ðŸš€ Collecting static files..."
                sudo python3 manage.py collectstatic --noinput
  
                echo "ðŸš€ Restarting Django server..."
                sudo pkill -f runserver || true  # Stop any running instance
                sudo nohup python3 manage.py runserver 0.0.0.0:8000 > server.log 2>&1 &
  
                echo "âœ… Django application deployed successfully!"
              EOF
  