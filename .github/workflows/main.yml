name: Deploy Django on Remote VM

on:
  workflow_dispatch:  # Allows manual trigger
  push:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install SSH Client & SSHPass
        run: sudo apt-get install -y openssh-client sshpass

      - name: Connect to VM & Check for Reboot
        run: |
          echo "ðŸš€ Checking if VM was rebooted..."
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no "${{ secrets.VM_USERNAME }}"@"${{ secrets.VM_IP }}" << 'EOF'
            if [ -f /tmp/reboot-required-action ]; then
                echo "ðŸ”„ System was rebooted. Removing flag and continuing deployment..."
                sudo rm -f /tmp/reboot-required-action
                exit 0
            fi
            echo "âœ… No reboot detected. Proceeding with system update..."
          EOF

      - name: Perform System Update & Reboot if Required
        id: update_system
        run: |
          echo "ðŸš€ Updating system..."
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_IP }} << 'EOF'
            export DEBIAN_FRONTEND=noninteractive
            sudo apt update -y && sudo apt upgrade -y
            sudo apt dist-upgrade -y

            if [ -f /var/run/reboot-required ]; then
                echo "âš ï¸ Kernel update detected! Marking reboot-required flag..."
                sudo touch /tmp/reboot-required-action
                sudo reboot
                exit 0
            fi
          EOF
        continue-on-error: true  # Prevents GitHub from marking the job as failed on reboot

      - name: Auto-Retry If Reboot Occurs
        if: failure() && steps.update_system.outcome == 'failure'
        run: |
          echo "âš ï¸ First run failed due to reboot. GitHub Actions will auto-retry this job."
          exit 1  # Forces GitHub Actions to retry the workflow

      - name: Connect to VM & Install Django
        run: |
          echo "ðŸš€ Connecting to Remote VM for Django Installation..."
          sshpass -p "${{ secrets.VM_PASSWORD }}" ssh -o PreferredAuthentications=password -o PubkeyAuthentication=no -o StrictHostKeyChecking=no ${{ secrets.VM_USERNAME }}@${{ secrets.VM_IP }} << 'EOF'
            echo "ðŸš€ Installing required packages..."
            sudo apt install -y python3 python3-pip

            echo "ðŸš€ Installing Django..."
            sudo -H pip3 install --upgrade pip
            sudo -H pip3 install django
          EOF
